# ccg-transact-api
Endpoint for storing ACH or Credit Card transactions in MSSQL DB


## Deployment Guide

This guide outlines the steps required to deploy the application behind an Nginx reverse proxy on an Ubuntu server, secured with a Let's Encrypt SSL certificate.

### Prerequisites

- An Ubuntu 18.04 or later server with root access
- A registered domain name pointing to your server

### Steps

1. **Install Node.js**

First, you will need to install Node.js on your Ubuntu server. You can do this with the following commands:

```bash
# Ubuntu 22.04 has Node 12 so we need to use the node source method to get something more current
curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

2. **Clone the application**

Next, clone your application to your server (requires a [deploy key!](https://docs.github.com/v3/guides/managing-deploy-keys/#deploy-keys)):

```bash
# Generate Deploy Key
ssh-keygen # Answer the prompts
cat ~/.ssh/id_rsa.pub # then put your public key into repository settings

# Now you're ready to clone
git clone git@github.com:phatjmo/ccg-transact-api.git
cd ccg-transact-api
npm install
```

3. **Install PM2**

PM2 is a process manager for Node.js applications. It will manage and keep your application online, even in the event of a crash.

```bash
npm install pm2 -g
```

Start your application with PM2:

```bash
pm2 start server.js
```

To ensure your application restarts on server reboot, you can use the startup script generated by:

```bash
pm2 startup
```

Then follow the instruction to run the generated command.

Note: Ensure logging is in /var/log using pm2-logrotate: https://pm2.keymetrics.io/docs/usage/log-management/

4. **Install Nginx**

Install Nginx using Ubuntu's package manager:

```bash
sudo apt update
sudo apt install nginx
```

5. **Configure Nginx**

Now you will configure Nginx to reverse proxy to your application. Open a new Nginx configuration file in a text editor:

```bash
sudo vim /etc/nginx/sites-available/ccg-transact-api
```

And add the following configuration:

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:3000; # change to the port your app runs on
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

Replace `yourdomain.com` with your domain name, and make sure the `proxy_pass` directive points to the port your app is running on.

Save and exit the text editor. Enable the new configuration by creating a symlink to the `sites-enabled` directory:

```bash
sudo ln -s /etc/nginx/sites-available/ccg-transact-api /etc/nginx/sites-enabled/
```

6. **Install Certbot**

Certbot is a tool that automates getting and installing SSL certificates with Let's Encrypt. You can install it with the following commands (Ref: https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-22-04)
# Ubuntu 22.04
```bash
sudo snap install core; sudo snap refresh core
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```

7. **Configure SSL**

Finally, you can configure SSL for your domain with the following command:

```bash
# Verify nginx config first:
sudo nginx -t
# Now run certbot
sudo certbot --nginx -d yourdomain.com -v
# Verify auto-renewal
sudo systemctl status snap.certbot.renew.service
# Test
sudo certbot renew --dry-run
```

Replace `yourdomain.com` with your domain name. Follow the on-screen prompts, and certbot will automatically configure Nginx to use SSL with your new certificate.


## API Key Authentication

This API uses API keys for authentication. The keys are stored in a `keys.json` file in the following format:

```json
{
  "keys": [
    "key1",
    "key2",
    // more keys...
  ]
}
```

Each request must include a valid API key in the `x-api-key` header or as an `x-api-key` query string parameter.

Example:

```
POST /api/transactions/[creditcard|ach]?x-api-key=your-api-key
```

Or in the request header:

```
x-api-key: your-api-key
```

### Generating API Keys

API keys can be generated using the included utility script. To generate a new API key, use the following command:

```bash
npm run generate-key
```

This will generate a new, 32-character long API key and print it out. Copy the generated key and add it to your `keys.json` file.

Remember to treat these keys as sensitive data, and be careful not to expose them publicly.


## Updating the service

Current releases should be in the main branch, so just pull the latest changes and restart the service.

```bash
git pull
```